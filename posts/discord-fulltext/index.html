<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>&lt;Discord å¦‚ä½• Full-text Index æ•¸åå„„çš„è¨Šæ¯> - Tachunn Publication</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Index å‰è¨€ éœ€æ±‚ è§£æ±ºæ–¹æ¡ˆ Question 1ï¼šæˆ‘è©²ç”¨å¤–éƒ¨çš„ SaaS å»è§£æ±ºé€™å€‹å•é¡Œå—ï¼Ÿ Question 2ï¼šæœ‰ Open-source çš„æ–¹æ¡ˆå¯ä»¥ç”¨å—ï¼Ÿ æˆ‘å€‘è©²â€å…¨é¢â€ç›¸ä¿¡ Elasticsearch å—ï¼Ÿ å…ƒä»¶çš„ç´°ç¯€ é«˜å±¤æ¬¡åˆ†æ Insert å…ƒä»¶ Shard Manage å…ƒä»¶ Indexing & Mapping the Data å¯¦éš›ä¸Š Coding çš„å¯¦ä½œ å¯¦éš›åœ¨ Production çš„éç¨‹ åˆå§‹åŒ–å¯¦é©— ç ”ç©¶çš„ç²¾ç¥ æ›´æ–°çš„ç…©æƒ± The Future Exampleï¼šUnhealthy Cluster (ran out of heap) Exampleï¼šHealthy Cluster çµè«– æ„Ÿæƒ³ å‰è¨€ é€™ç¯‡éƒ¨è½æ ¼æœƒç¿»è­¯å’Œåƒè€ƒ <How discord indexes billions of messages> é€™ç¯‡æ–‡ç« çš„å…§å®¹åšæ•´ç†å’Œç¿»è­¯ã€‚
é€™ç¯‡ç®—æ˜¯ <Discord å¦‚ä½•è™•ç†æ•¸åå„„çš„è¨Šæ¯> çš„ä¸‹é›†ï¼Œç•¶æœ‰äº†æœ€æ ¸å¿ƒçš„è¨Šæ¯è®€å¯«ç³»çµ±ã€‚ä¸‹ä¸€å€‹å¾ˆé‡è¦çš„ feature å°±æ˜¯ Full-text Searchã€‚
èˆ‰ä¾‹ä¾†èªªï¼ŒUser çªç„¶æƒ³åˆ°ä»¥å‰å’ŒåŒä¼´è¨è«–çš„æŸå€‹è­°é¡Œï¼Œä¸å¯èƒ½æ…¢æ…¢æ»‘å»æ‰¾ï¼Œè€Œæ˜¯è¦ç”¨åƒæ˜¯ Search Engine é€™æ¨£çš„åŠŸèƒ½ï¼Œé€™ç¯‡æ–‡ç« å°±æ˜¯åœ¨ä»‹ç´¹ Discord å¦‚ä½•åšåˆ°é€™ç¨®åŠŸèƒ½ã€‚"><meta property="og:image" content><meta property="og:title" content="<Discord å¦‚ä½• Full-text Index æ•¸åå„„çš„è¨Šæ¯>"><meta property="og:description" content="Index å‰è¨€ éœ€æ±‚ è§£æ±ºæ–¹æ¡ˆ Question 1ï¼šæˆ‘è©²ç”¨å¤–éƒ¨çš„ SaaS å»è§£æ±ºé€™å€‹å•é¡Œå—ï¼Ÿ Question 2ï¼šæœ‰ Open-source çš„æ–¹æ¡ˆå¯ä»¥ç”¨å—ï¼Ÿ æˆ‘å€‘è©²â€å…¨é¢â€ç›¸ä¿¡ Elasticsearch å—ï¼Ÿ å…ƒä»¶çš„ç´°ç¯€ é«˜å±¤æ¬¡åˆ†æ Insert å…ƒä»¶ Shard Manage å…ƒä»¶ Indexing & Mapping the Data å¯¦éš›ä¸Š Coding çš„å¯¦ä½œ å¯¦éš›åœ¨ Production çš„éç¨‹ åˆå§‹åŒ–å¯¦é©— ç ”ç©¶çš„ç²¾ç¥ æ›´æ–°çš„ç…©æƒ± The Future Exampleï¼šUnhealthy Cluster (ran out of heap) Exampleï¼šHealthy Cluster çµè«– æ„Ÿæƒ³ å‰è¨€ é€™ç¯‡éƒ¨è½æ ¼æœƒç¿»è­¯å’Œåƒè€ƒ <How discord indexes billions of messages> é€™ç¯‡æ–‡ç« çš„å…§å®¹åšæ•´ç†å’Œç¿»è­¯ã€‚
é€™ç¯‡ç®—æ˜¯ <Discord å¦‚ä½•è™•ç†æ•¸åå„„çš„è¨Šæ¯> çš„ä¸‹é›†ï¼Œç•¶æœ‰äº†æœ€æ ¸å¿ƒçš„è¨Šæ¯è®€å¯«ç³»çµ±ã€‚ä¸‹ä¸€å€‹å¾ˆé‡è¦çš„ feature å°±æ˜¯ Full-text Searchã€‚
èˆ‰ä¾‹ä¾†èªªï¼ŒUser çªç„¶æƒ³åˆ°ä»¥å‰å’ŒåŒä¼´è¨è«–çš„æŸå€‹è­°é¡Œï¼Œä¸å¯èƒ½æ…¢æ…¢æ»‘å»æ‰¾ï¼Œè€Œæ˜¯è¦ç”¨åƒæ˜¯ Search Engine é€™æ¨£çš„åŠŸèƒ½ï¼Œé€™ç¯‡æ–‡ç« å°±æ˜¯åœ¨ä»‹ç´¹ Discord å¦‚ä½•åšåˆ°é€™ç¨®åŠŸèƒ½ã€‚"><meta property="og:type" content="article"><meta property="og:url" content="https://tachunwu.github.io/posts/discord-fulltext/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-01-30T18:02:17+08:00"><meta property="article:modified_time" content="2023-01-30T18:02:17+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="<Discord å¦‚ä½• Full-text Index æ•¸åå„„çš„è¨Šæ¯>"><meta name=twitter:description content="Index å‰è¨€ éœ€æ±‚ è§£æ±ºæ–¹æ¡ˆ Question 1ï¼šæˆ‘è©²ç”¨å¤–éƒ¨çš„ SaaS å»è§£æ±ºé€™å€‹å•é¡Œå—ï¼Ÿ Question 2ï¼šæœ‰ Open-source çš„æ–¹æ¡ˆå¯ä»¥ç”¨å—ï¼Ÿ æˆ‘å€‘è©²â€å…¨é¢â€ç›¸ä¿¡ Elasticsearch å—ï¼Ÿ å…ƒä»¶çš„ç´°ç¯€ é«˜å±¤æ¬¡åˆ†æ Insert å…ƒä»¶ Shard Manage å…ƒä»¶ Indexing & Mapping the Data å¯¦éš›ä¸Š Coding çš„å¯¦ä½œ å¯¦éš›åœ¨ Production çš„éç¨‹ åˆå§‹åŒ–å¯¦é©— ç ”ç©¶çš„ç²¾ç¥ æ›´æ–°çš„ç…©æƒ± The Future Exampleï¼šUnhealthy Cluster (ran out of heap) Exampleï¼šHealthy Cluster çµè«– æ„Ÿæƒ³ å‰è¨€ é€™ç¯‡éƒ¨è½æ ¼æœƒç¿»è­¯å’Œåƒè€ƒ <How discord indexes billions of messages> é€™ç¯‡æ–‡ç« çš„å…§å®¹åšæ•´ç†å’Œç¿»è­¯ã€‚
é€™ç¯‡ç®—æ˜¯ <Discord å¦‚ä½•è™•ç†æ•¸åå„„çš„è¨Šæ¯> çš„ä¸‹é›†ï¼Œç•¶æœ‰äº†æœ€æ ¸å¿ƒçš„è¨Šæ¯è®€å¯«ç³»çµ±ã€‚ä¸‹ä¸€å€‹å¾ˆé‡è¦çš„ feature å°±æ˜¯ Full-text Searchã€‚
èˆ‰ä¾‹ä¾†èªªï¼ŒUser çªç„¶æƒ³åˆ°ä»¥å‰å’ŒåŒä¼´è¨è«–çš„æŸå€‹è­°é¡Œï¼Œä¸å¯èƒ½æ…¢æ…¢æ»‘å»æ‰¾ï¼Œè€Œæ˜¯è¦ç”¨åƒæ˜¯ Search Engine é€™æ¨£çš„åŠŸèƒ½ï¼Œé€™ç¯‡æ–‡ç« å°±æ˜¯åœ¨ä»‹ç´¹ Discord å¦‚ä½•åšåˆ°é€™ç¨®åŠŸèƒ½ã€‚"><script src=https://tachunwu.github.io/js/feather.min.js></script>
<link href=https://tachunwu.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://tachunwu.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css></head><body><div class=content><header><script async src="https://www.googletagmanager.com/gtag/js?id=G-2LYZQ778V0"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2LYZQ778V0")</script><div class=main><a href=https://tachunwu.github.io/>Tachunn Publication</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about>About</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>&lt;Discord å¦‚ä½• Full-text Index æ•¸åå„„çš„è¨Šæ¯></h1><div class=meta>Posted on Jan 30, 2023</div></div><section class=body><p><img src=/images/discord-fulltext_head.png alt><div><h2>Index</h2><nav id=TableOfContents><ol><li><a href=#å‰è¨€><strong>å‰è¨€</strong></a></li><li><a href=#éœ€æ±‚><strong>éœ€æ±‚</strong></a></li><li><a href=#è§£æ±ºæ–¹æ¡ˆ><strong>è§£æ±ºæ–¹æ¡ˆ</strong></a><ol><li><a href=#question-1æˆ‘è©²ç”¨å¤–éƒ¨çš„-saas-å»è§£æ±ºé€™å€‹å•é¡Œå—><strong>Question 1ï¼šæˆ‘è©²ç”¨å¤–éƒ¨çš„ SaaS å»è§£æ±ºé€™å€‹å•é¡Œå—ï¼Ÿ</strong></a></li><li><a href=#question-2æœ‰-open-source-çš„æ–¹æ¡ˆå¯ä»¥ç”¨å—><strong>Question 2ï¼šæœ‰ Open-source çš„æ–¹æ¡ˆå¯ä»¥ç”¨å—ï¼Ÿ</strong></a></li></ol></li><li><a href=#æˆ‘å€‘è©²å…¨é¢ç›¸ä¿¡-elasticsearch-å—><strong>æˆ‘å€‘è©²â€å…¨é¢â€ç›¸ä¿¡ Elasticsearch å—ï¼Ÿ</strong></a></li><li><a href=#å…ƒä»¶çš„ç´°ç¯€><strong>å…ƒä»¶çš„ç´°ç¯€</strong></a><ol><li><a href=#é«˜å±¤æ¬¡åˆ†æ><strong>é«˜å±¤æ¬¡åˆ†æ</strong></a></li><li><a href=#insert-å…ƒä»¶><strong>Insert å…ƒä»¶</strong></a></li><li><a href=#shard-manage-å…ƒä»¶><strong>Shard Manage å…ƒä»¶</strong></a></li></ol></li><li><a href=#indexing--mapping-the-data><strong>Indexing & Mapping the Data</strong></a></li><li><a href=#å¯¦éš›ä¸Š-coding-çš„å¯¦ä½œ><strong>å¯¦éš›ä¸Š Coding çš„å¯¦ä½œ</strong></a></li><li><a href=#å¯¦éš›åœ¨-production-çš„éç¨‹><strong>å¯¦éš›åœ¨ Production çš„éç¨‹</strong></a><ol><li><a href=#åˆå§‹åŒ–å¯¦é©—><strong>åˆå§‹åŒ–å¯¦é©—</strong></a></li><li><a href=#ç ”ç©¶çš„ç²¾ç¥><strong>ç ”ç©¶çš„ç²¾ç¥</strong></a></li><li><a href=#æ›´æ–°çš„ç…©æƒ±><strong>æ›´æ–°çš„ç…©æƒ±</strong></a></li></ol></li><li><a href=#the-future><strong>The Future</strong></a><ol><li><a href=#exampleunhealthy-cluster-ran-out-of-heap>Exampleï¼šUnhealthy Cluster (ran out of heap)</a></li><li><a href=#examplehealthy-cluster>Exampleï¼š<strong><strong>Healthy Cluster</strong></strong></a></li></ol></li><li><a href=#çµè«–><strong>çµè«–</strong></a></li><li><a href=#æ„Ÿæƒ³><strong>æ„Ÿæƒ³</strong></a></li></ol></nav></div></p><h1 id=å‰è¨€><strong>å‰è¨€</strong></h1><p>é€™ç¯‡éƒ¨è½æ ¼æœƒç¿»è­¯å’Œåƒè€ƒ &lt;<a href=https://discord.com/blog/how-discord-indexes-billions-of-messages>How discord indexes billions of messages</a>> é€™ç¯‡æ–‡ç« çš„å…§å®¹åšæ•´ç†å’Œç¿»è­¯ã€‚</p><p>é€™ç¯‡ç®—æ˜¯ &lt;<a href=https://tachunwu.github.io/posts/discord-cassandra/>Discord å¦‚ä½•è™•ç†æ•¸åå„„çš„è¨Šæ¯</a>> çš„ä¸‹é›†ï¼Œç•¶æœ‰äº†æœ€æ ¸å¿ƒçš„è¨Šæ¯è®€å¯«ç³»çµ±ã€‚ä¸‹ä¸€å€‹å¾ˆé‡è¦çš„ feature å°±æ˜¯ <strong>Full-text Search</strong>ã€‚</p><p><strong>èˆ‰ä¾‹ä¾†èªªï¼ŒUser çªç„¶æƒ³åˆ°ä»¥å‰å’ŒåŒä¼´è¨è«–çš„æŸå€‹è­°é¡Œï¼Œä¸å¯èƒ½æ…¢æ…¢æ»‘å»æ‰¾ï¼Œè€Œæ˜¯è¦ç”¨åƒæ˜¯ Search Engine é€™æ¨£çš„åŠŸèƒ½ï¼Œé€™ç¯‡æ–‡ç« å°±æ˜¯åœ¨ä»‹ç´¹ Discord å¦‚ä½•åšåˆ°é€™ç¨®åŠŸèƒ½ã€‚</strong></p><h1 id=éœ€æ±‚><strong>éœ€æ±‚</strong></h1><p>ä¸€é–‹å§‹ä½œè€…å…ˆæŠŠéœ€æ±‚çµ¦ç¾…åˆ—æ¸…æ¥šï¼š</p><ul><li><strong><a href>Cost Effective</a></strong>ï¼š</li></ul><p>å°æ–¼ Discord ä¾†èªªï¼Œä¸»è¦çš„æœå‹™é‚„æ˜¯èªéŸ³å’Œè¨Šæ¯ï¼Œ<strong>å…¨æ–‡æœå°‹çš„åŠŸèƒ½ç®—æ˜¯é™„åŠ çš„åŠŸèƒ½</strong>ï¼Œå°±æ„å‘³è‘—æˆ‘å€‘<strong>ä¸æ‡‰è©²åœ¨é€™å€‹åŠŸèƒ½èŠ±éå¤šå¾—è²»ç”¨ (è‡³å°‘è¦æ¯”èªéŸ³å’Œè¨Šæ¯çš„ Infra é‚„å°‘ï¼)</strong></p><ul><li><strong><a href>Fast & Intuitive</a></strong>ï¼š</li></ul><p>ç•¶ç„¶åŠ ä¸€å€‹æ–°åŠŸèƒ½éœ€è¦èƒ½è®“ä½¿ç”¨è€…è¦ºå¾—å¾ˆé †åˆ©å¾ˆå¥½ç”¨ï¼Œé€™æ˜¯åŸºæœ¬ã€‚</p><ul><li><strong><a href>Self-healing</a></strong>ï¼š</li></ul><p>ç”±æ–¼æˆ‘å€‘çš„åœ˜éšŠé‚„æ²’æœ‰ DevOps åœ˜éšŠï¼Œæˆ‘å€‘å¸Œæœ›å¯ä»¥ Self-healing</p><ul><li><strong><a href>Linearly Scalable</a></strong>ï¼š</li></ul><p>ç•¢ç«Ÿ Discord æ˜¯è¶…å¤§æµé‡çš„å…¬å¸ï¼Œæˆ‘å€‘ç•¶ç„¶å¸Œæœ›èƒ½å¤ <strong>å–®ç´”å¢åŠ  Node å°±èƒ½å¢åŠ  throughput</strong>ã€‚</p><ul><li><strong><a href>Lazily Indexed</a></strong>ï¼š</li></ul><p>ç”±æ–¼ä¸¦ä¸æ˜¯æ¯ä¸€å€‹ User éƒ½æœƒä½¿ç”¨ Indexï¼Œ<strong>åªè¦ User ä¸ä½¿ç”¨æˆ‘å€‘å°±ä¸è©²åšé€™ä»¶äº‹æƒ…</strong>ï¼Œå¦å¤–å¦‚æœ Index å¤±æ•—äº†ï¼Œæˆ‘å€‘è¦æœ‰è¾¦æ³•é‡æ–° Indexã€‚</p><h1 id=è§£æ±ºæ–¹æ¡ˆ><strong>è§£æ±ºæ–¹æ¡ˆ</strong></h1><p>ç•¶æˆ‘å€‘ä»”ç´°æ€é‡ä¸Šé¢çµ±æ•´çš„éœ€æ±‚ï¼Œæˆ‘å€‘ç¸½å’Œå‡ºäº†å…©å€‹ä¸»è¦å•é¡Œã€‚</p><h2 id=question-1æˆ‘è©²ç”¨å¤–éƒ¨çš„-saas-å»è§£æ±ºé€™å€‹å•é¡Œå—><strong>Question 1ï¼šæˆ‘è©²ç”¨å¤–éƒ¨çš„ SaaS å»è§£æ±ºé€™å€‹å•é¡Œå—ï¼Ÿ</strong></h2><p>é€™é¡Œçš„ç­”æ¡ˆçµ•å°æ˜¯ä¸è¡Œï¼åœ¨ Discord é€™å€‹ Scale æˆ‘å€‘åƒè€ƒäº†ä¸€äº›å¤–éƒ¨çš„å» å•†ï¼Œæœƒç™¼ç¾é ç®—ä¸€å®šæœƒçˆ†ç‚¸â€¦ã€‚å†ä¾†ï¼Œæˆ‘å€‘å°æ–¼éš±ç§æœ‰å¾ˆå¤§çš„è€ƒé‡ï¼Œå¦‚æœæŠŠè³‡æ–™é‹å‡ºå»æˆ‘å€‘çš„ Data Center èª°çŸ¥é“é‚£äº›å» å•†æœƒä¸æœƒä¿è­·å¥½æˆ‘å€‘çš„è³‡æ–™ï¼Ÿ</p><h2 id=question-2æœ‰-open-source-çš„æ–¹æ¡ˆå¯ä»¥ç”¨å—><strong>Question 2ï¼šæœ‰ Open-source çš„æ–¹æ¡ˆå¯ä»¥ç”¨å—ï¼Ÿ</strong></h2><p>æœ‰çš„ï¼æˆ‘å€‘å…§éƒ¨è¨è«–ä¹‹å¾Œï¼Œç™¼ç¾æœ‰ Elasticsearch å’Œ Solr å¯ä»¥é¸æ“‡ï¼Œæˆ‘å€‘ç™¼ç¾ Elasticsearch æœ‰ä»¥ä¸‹å„ªå‹¢ã€‚</p><ul><li><a href>Solr æœ¬èº«éœ€è¦æ­é… ZooKeeperï¼Œæˆ‘å€‘å…§éƒ¨æ˜¯ç”¨ etcdï¼Œæˆ‘å€‘ä¸æƒ³èŠ±ç²¾åŠ›å»ç¶­è­·é¡å¤–çš„åŸºç¤è¨­æ–½</a>ã€‚é‚„æœ‰ Elasticsearchâ€™s Zen æœ¬èº«æœ‰å…§å»ºçš„æœå‹™ç™¼ç¾ï¼Œé€™æ–¹é¢æ¯” Solr æœ‰æ›´å¤šå„ªå‹¢ã€‚</li><li>Elasticsearch æ”¯æ´ <a href>automatic shard rebalancing (åˆ†ç‰‡è‡ªå‹•å¹³è¡¡)</a>ï¼Œç•¶æˆ‘å€‘å¢åŠ æ–°çš„ Node å¯ä»¥æ»¿è¶³ Linearly Scalable é€™å€‹éœ€æ±‚ã€‚</li><li>Elasticsearch æœ¬èº«æœ‰å…§å»ºè‡ªå·±çš„æŸ¥è©¢èªè¨€ (structured query DSL)ï¼Œä¸éœ€è¦åƒ Solr å¯«ç¬¬ä¸‰æ–¹çš„æŸ¥è©¢å­—ä¸²ã€‚</li><li>æˆ‘å€‘çš„å·¥ç¨‹å¸«å° Elasticsearch æ¯”è¼ƒæœ‰ç¶“é©—â€¦ XD</li></ul><p><em><a href>è¨»è¨˜1</a>ï¼šé€™ç¯‡æ–‡ç« æ˜¯ 2017 å¹´å¯«çš„ï¼Œé‚£æ™‚çš„ Full-text åŸºç¤è¨­æ–½çš„ç¢ºä¸å¤šï¼Œä½†æ˜¯ç¾åœ¨å·²ç¶“æœ‰å¾ˆæ–°çš„è§£æ±ºæ–¹æ¡ˆï¼Œä¾‹å¦‚ï¼šMeilisearchã€Zincã€Typesenseï¼Œç”šè‡³å¦‚æœä½ æµé‡æ²’æœ‰åƒ Discord é‚£æ‘©æš´åŠ›ï¼ŒPostgres æœ¬èº«å…¶å¯¦ä¹Ÿæœ‰ Full-text Searchã€‚</em></p><p><em><a href>è¨»è¨˜2</a>ï¼šautomatic shard rebalancingï¼Œé€™å€‹è©çš„æ„æ€æ˜¯æŒ‡ç•¶è³‡æ–™é‡éå¤§æ™‚å¿…é ˆè¦åˆ†æ•£åœ¨ä¸åŒçš„ Nodeé€™æ˜¯ shard çš„æ„æ€ã€‚ç•¶å¢åŠ æ–°çš„ Node è£¡é¢é‚„æ²’æœ‰è³‡æ–™è¼ƒéœ€è¦æŠŠéƒ¨åˆ†è³‡æ–™åšæ¬ç§»ï¼Œå°±æ˜¯ rebalancingã€‚è€Œ automatic å°±æ˜¯ç…§æ•´å€‹éç¨‹æ˜¯ç³»çµ±è‡ªå‹•å®Œæˆçš„ (Actually é€™å€‹ feature æ˜¯å¾ˆé›£åšçš„å¦‚æœåˆè¦ online åš)ã€‚</em></p><h1 id=æˆ‘å€‘è©²å…¨é¢ç›¸ä¿¡-elasticsearch-å—><strong>æˆ‘å€‘è©²â€å…¨é¢â€ç›¸ä¿¡ Elasticsearch å—ï¼Ÿ</strong></h1><p>ç¶“ç”±æˆ‘å€‘çš„åˆ†æ Elasticsearch é›–ç„¶æ‰€æœ‰æˆ‘å€‘æƒ³è¦çš„ feature éƒ½æœ‰æä¾›ï¼Œä½†æ˜¯æˆ‘å€‘ä¸¦æ²’æœ‰ç®¡ç†å¤§å‹ Elasticsearch Cluster çš„ç¶“é©—ï¼Œæˆ‘å€‘ç›®å‰åªæœ‰æ‹¿ä¾†åš log çš„ç”¨é€”ï¼ŒAll-inå¯¦åœ¨æ˜¯æœƒæ€•ã€‚</p><p>æ‰€ä»¥æˆ‘å€‘é¸æ“‡ä¸€å€‹æŠ˜è¡·çš„æ–¹æ¡ˆï¼Œ<strong>æˆ‘å€‘åœ¨ Application Layer åš sharding å’Œ routing</strong>ï¼Œ<strong>æˆ‘å€‘ç¶­è­·å¾ˆå¤šå°å°çš„ Elasticsearch Clusterï¼Œå°±ç®—æ•…éšœäº†ï¼Œä¹Ÿåªæœ‰é‚£å€‹ shard çš„ user æœƒè¢«å½±éŸ¿ã€‚å°±ç®—æ›´èª‡å¼µä¸€é»ï¼Œæ•´å€‹å° Cluster éƒ½æ­»äº†ï¼Œä¸‹æ¬¡å† lazily re-index å°±å¥½ã€‚</strong></p><h1 id=å…ƒä»¶çš„ç´°ç¯€><strong>å…ƒä»¶çš„ç´°ç¯€</strong></h1><h2 id=é«˜å±¤æ¬¡åˆ†æ><strong>é«˜å±¤æ¬¡åˆ†æ</strong></h2><p><strong>Elasticsearch èªæ„ä¸Šæ˜¯ä»¥ bulk çš„æ–¹å¼ indexed</strong>ï¼Œä¹Ÿå°±æ„å‘³è‘—æˆ‘å€‘æ²’è¾¦æ³• Real-time çš„æ›´æ–°ã€‚æˆ‘å€‘<strong>æ¡å–ä¸€å€‹ Queue çš„æ–¹å¼ï¼Œå†ç”¨ worker batch å¯«å…¥</strong>ã€‚è‡³æ–¼é€™ç¨®å»¶é²ä¹‹æ‰€ä»¥å¯ä»¥å¿å—ï¼Œæ˜¯<strong>å› ç‚ºå¤šåŠç”¨åˆ° Full-text çš„äººéƒ½æ˜¯æœå°‹æ­·å²ç´€éŒ„ï¼Œæ²’æœ‰å¿…è¦åšåˆ° Real-time</strong>ï¼Œä»¥ä¸‹æˆ‘å€‘é–‹å§‹ä»‹ç´¹æœ‰ä»€éº¼å…ƒä»¶ã€‚</p><h2 id=insert-å…ƒä»¶><strong>Insert å…ƒä»¶</strong></h2><ul><li><strong><a href>Message Queue</a></strong>ï¼šå¯ä»¥å…ˆæŠŠ Messages buffer èµ·ä¾†ã€‚</li><li><strong><a href>Index Workers</a></strong>ï¼šå°ˆé–€æŠŠ Messages å¾ Message Queue é€å…¥ Elasticsearchã€‚</li><li><strong><a href>Historical Index Workers</a></strong>ï¼šè² è²¬æŠŠ Messages æ­·å²ç´€éŒ„ é€å…¥ Elasticsearchã€‚</li></ul><h2 id=shard-manage-å…ƒä»¶><strong>Shard Manage å…ƒä»¶</strong></h2><p>ç”±æ–¼å‰›å‰›æˆ‘ä¸Šé¢æœ‰èªª <strong>Discord è‡ªè¡Œç®¡ç†å¾ˆå¤š Elastic Search Cluster</strong>ï¼Œ<strong>æˆ‘å€‘æŠŠ (Elasticsearch cluster, Discord server Index) ä½œç‚º shard çš„ç®¡ç†</strong>ï¼Œå°±æ˜¯ Application éœ€è¦æŠŠ cluster + index è½‰æ›æˆ shardï¼Œåˆå¯ä»¥æ‹†åˆ†æˆä»¥ä¸‹å…©å±¤ï¼š</p><ul><li><strong><a href>Persistent Shard Mapping</a></strong>ï¼š</li></ul><p>æˆ‘å€‘æŠŠé€™ç¨® <strong>Mapping æ”¾åœ¨ Cassandra (æˆ‘å€‘çš„ä¸»è¦è³‡æ–™åº«)</strong></p><ul><li><strong><a href>Shard Mapping Cache</a></strong>ï¼š</li></ul><p>å¦‚æœæ¯æ¬¡ Discord server è¦å»æ‰¾è‡ªå·±çš„ Full-text Index shardï¼Œéƒ½è¦é€²å» Cassandra æŸ¥æœƒå¾ˆæµªè²»æ™‚é–“ï¼Œ<strong>æ‰€ä»¥ç”¨ Redis Cache èµ·ä¾†ï¼Œä¸¦ä¸”ç”¨ mget ä¾†å¾—åˆ°çµæœ</strong>ã€‚</p><p>ç•¶ Discord server ç¬¬ä¸€æ¬¡è«‹æ±‚ Index æ™‚æˆ‘å€‘éœ€è¦æ±ºå®šè¦ç”¨å“ªä¸€å€‹ Shardï¼Œç”±æ–¼é‚è¼¯æ˜¯å¯«åœ¨ Application æˆ‘å€‘ç”¨ Redis åšäº†ä¸€å€‹ <strong>load aware shard allocator</strong>ã€‚</p><ul><li><strong><a href>Shard Allocator</a></strong>ï¼š</li></ul><p><strong>æˆ‘å€‘ç”¨ Redis çš„ sorted set ä¾†å¯¦ä½œï¼Œæˆ‘å€‘å¹«æ¯ä¸€å€‹ Shard æ’åºä¸€å€‹åˆ†æ•¸ï¼Œåˆ†æ•¸æ„å‘³ loadï¼Œå¾—åˆ†æœ€ä½çš„å°±æœƒæ˜¯ä¸‹æ¬¡è¢«åˆ†é…çš„ shardã€‚æ¯ä¸€æ¬¡åˆ†é…éƒ½æœƒæ›´æ–°åˆ†æ•¸ï¼Œç•¶ shard çš„åˆ†æ•¸è®Šé«˜ï¼Œæœªä¾†è¢«åˆ†é…åˆ°çš„æ©Ÿç‡å°±æœƒè¶Šä½ã€‚</strong></p><p>é›–ç„¶ä¸Šé¢çš„è¨­è¨ˆå·²ç¶“å¾ˆå®Œæ•´äº†ï¼Œ<strong>ä½†æ˜¯è¦èƒ½å¤ å‹•èµ·ä¾†éœ€è¦è®“æœå‹™è¢«ç™¼ç¾ï¼Œæˆ‘å€‘éœ€è¦å”èª¿ Application å’Œ Infra</strong>ã€‚</p><ul><li><strong><a href>etcd</a></strong>ï¼š</li></ul><p>é€™å€‹å·¥ä½œå°±ç”± <strong>etcd è² è²¬ service discovery</strong>ï¼Œetcd å¯ä»¥ç®¡ç†çš„å¾ˆå¥½ï¼Œæˆ‘å€‘ä¸ç”¨å»æ‰‹åˆ»Elasticsearch topologies ç®¡ç†å±¤ã€‚</p><ul><li><strong><a href>Search API</a></strong>ï¼š</li></ul><p>æœ€å¤–å±¤é‚„æ˜¯è¦åŒ…æˆ APIï¼Œä¸»è¦åªæ˜¯é©—è­‰æœ‰æ²’æœ‰æ¬Šé™å»å¯Ÿçœ‹æŸäº› Index</p><p><em><a href>è¨»è¨˜</a>ï¼šetcd å¯æ˜¯ kubernetes çš„æ ¸å¿ƒï¼ŒåŸºæœ¬ä¸Šå±¬æ–¼è¶…ç´šå¼·çš„å¯¦æˆ°ç³»çµ±ï¼Respectï¼</em></p><h1 id=indexing--mapping-the-data><strong>Indexing & Mapping the Data</strong></h1><p>åœ¨æœ€æŠ½è±¡çš„å±¤æ¬¡ï¼Œ<strong>æˆ‘å€‘å…¶å¯¦å°±åªæ˜¯ä¸€å † shards è€Œé€™äº› shards æ˜¯ Lucene index</strong> (å¦‚æœå»æŸ¥ä¸€ä¸‹ wikiï¼ŒElasticsearch å°±æ˜¯ç”¨ Apache Lucene Java Library å¯¦ä½œçš„)ã€‚å¦‚æœä½ æƒ³è¦ä½ å¯ä»¥ç”¨ <strong>routing key</strong> ä¾†åˆ†é… sharding çš„ä½ç½®ã€‚</p><p>ç´°ç¯€ä¸Šæˆ‘å€‘é‚„å¯ä»¥è¨­è¨ˆ replicaï¼Œ<strong>è¤‡è£½å¤šä»½åŒæ¨£çš„ shard ä¸€ä¾†å¯ä»¥å¢åŠ  HA çš„ç‰¹æ€§ï¼ŒäºŒä¾†å¯ä»¥è¡é«˜ç‰¹å®šç†±é–€ shard çš„ throughputã€‚</strong></p><p><strong>é›–ç„¶æˆ‘å€‘å·²ç¶“è‡ªå·±åœ¨ Application Level æ‰‹åˆ» Shardingï¼Œæˆ‘å€‘å£“æ ¹æ²’åœ¨ç”¨ Elasticsearch shardï¼Œä½†æ˜¯ replication å’Œ balancing åœ¨ Elasticsearch å° cluster é‚„æ˜¯è »å¥½ç”¨çš„ï¼Œä»¥ä¸‹å°±ä»‹ç´¹ä¸€ä¸‹æˆ‘å€‘æ€éº¼è¨­å®šã€‚</strong></p><ul><li><a href>index åªèƒ½æœ‰å±¬æ–¼ä¸€å€‹ shard</a></li><li><a href>index æ‡‰è©² replicated åˆ°å¦å¤–ä¸€å€‹ nodeï¼Œprimary æ›æ‰äº†æœå‹™é‚„èƒ½ç¹¼çºŒ</a></li><li><a href>index 60 ç§’åˆ·æ–°ä¸€æ¬¡ï¼Œç‚ºä»€éº¼ä¸æ˜¯ Real-time ä¸Šé¢æœ‰è§£é‡‹</a></li><li><a href>index åªæœ‰ä¸€ç¨® document typeï¼šmessage</a></li></ul><p>æœ€å¾Œä¸€é»ç‰¹åˆ¥è§£é‡‹ï¼Œæˆ‘å€‘ä¸å­˜åŸå§‹çš„è³‡æ–™ï¼Œé€™ç¨®æ„ç¾©ä¸å¤§ï¼Œæˆ‘å€‘é †ä¾¿æŠŠ metadata å•¥çš„å…¨éƒ½å¡é€²å»ï¼Œé€™æ¨£å°±å¯ä»¥æœåˆ°è¶…å¤šæ±è¥¿ï¼Œä»¥ä¸‹æ˜¯æˆ‘å€‘ index æ¨¡æ¿çš„ç¯„ä¾‹ã€‚å¯ä»¥çœ‹åˆ°ï¼Œç¸®æœ‰æ±è¥¿éƒ½å¡â€¦å¡é€²å»äº†ï¼Œç°¡å–®æš´åŠ›ï¼</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;template&#39;</span>: <span style=color:#e6db74>&#39;m-*&#39;</span>,
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;settings&#39;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;number_of_shards&#39;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;number_of_replicas&#39;</span>: <span style=color:#ae81ff>1</span>,
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;index.refresh_interval&#39;</span>: <span style=color:#e6db74>&#39;3600s&#39;</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;mappings&#39;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#39;message&#39;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;_source&#39;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;includes&#39;</span>: [
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;id&#39;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;channel_id&#39;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;guild_id&#39;</span>
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>            },
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;properties&#39;</span>: {
</span></span><span style=display:flex><span>                <span style=color:#75715e># This is the message_id, we index by this to allow for greater than/less than queries, so we can search</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># before, on, and after.</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;id&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;long&#39;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># Lets us search with the &#34;in:#channel-name&#34; modifier.</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;channel_id&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;long&#39;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># Lets us scope a search to a given server.</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;guild_id&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;long&#39;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># Lets us search &#34;from:Someone#0001&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;author_id&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;long&#39;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># Is the author a user, bot or webhook? Not yet exposed in client.</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;author_type&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;byte&#39;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># Regular chat message, system message...</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;type&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;short&#39;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># Who was mentioned, &#34;mentions:Person#1234&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;mentions&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;long&#39;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># Was &#34;@everyone&#34; mentioned (only true if the author had permission to @everyone at the time).</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># This accounts for the case where &#34;@everyone&#34; could be in a message, but it had no effect, </span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># because the user doesn&#39;t have permissions to ping everyone. </span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;mention_everyone&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;boolean&#39;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># Array of [message content, embed title, embed author, embed description, ...]</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># for full-text search.</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;content&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;text&#39;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;fields&#39;</span>: {
</span></span><span style=display:flex><span>                        <span style=color:#e6db74>&#39;lang_analyzed&#39;</span>: {
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;text&#39;</span>,
</span></span><span style=display:flex><span>                            <span style=color:#e6db74>&#39;analyzer&#39;</span>: <span style=color:#e6db74>&#39;english&#39;</span>
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># An array of shorts, specifying what type of media the message has. &#34;has:link|image|video|embed|file&#34;.</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;has&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;short&#39;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># An array of normalized hostnames in the message, traverse up to the domain. Not yet exposed in client.</span>
</span></span><span style=display:flex><span>                <span style=color:#75715e># &#34;http://foo.bar.com&#34; gets turned into [&#34;foo.bar.com&#34;, &#34;bar.com&#34;]</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;link_hostnames&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;keyword&#39;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># Embed providers as returned by oembed, i.e. &#34;Youtube&#34;. Not yet exposed in client.</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;embed_providers&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;keyword&#39;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># Embed type as returned by oembed. Not yet exposed in client.</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;embed_types&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;keyword&#39;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># File extensions of attachments, i.e. &#34;fileType:mp3&#34;</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;attachment_extensions&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;keyword&#39;</span>
</span></span><span style=display:flex><span>                },
</span></span><span style=display:flex><span>                <span style=color:#75715e># The filenames of the attachments. Not yet exposed in client.</span>
</span></span><span style=display:flex><span>                <span style=color:#e6db74>&#39;attachment_filenames&#39;</span>: {
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;type&#39;</span>: <span style=color:#e6db74>&#39;text&#39;</span>,
</span></span><span style=display:flex><span>                    <span style=color:#e6db74>&#39;analyzer&#39;</span>: <span style=color:#e6db74>&#39;simple&#39;</span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ä½œè€…æœ‰æåˆ°ä»–å€‘<strong>ä¸¦æ²’æœ‰ç›´æ¥æŠŠ messages å­˜åˆ° Elasticsearchï¼Œè€Œæ˜¯ç•¶ inverted index ç”¨</strong>ï¼Œæ‰€ä»¥ç•¶ä½ æœå°‹æŸäº›é—œéµå­—ï¼Œ<strong>Elasticsearch ä¸èƒ½ç›´æ¥çµ¦ä½ è³‡æ–™ï¼Œè€Œæ˜¯çµ¦ä½  message, channel å’Œ server IDï¼Œä½ é‚„æ˜¯éœ€è¦æ‹¿é€™äº›æ±è¥¿å» Cassandra å–å›åŸå§‹è³‡æ–™</strong>ã€‚</p><h1 id=å¯¦éš›ä¸Š-coding-çš„å¯¦ä½œ><strong>å¯¦éš›ä¸Š Coding çš„å¯¦ä½œ</strong></h1><p>æˆ‘å€‘æ±ºå®šä¸ç”¨å¾®æœå‹™ï¼Œè€Œæ˜¯å¯«ä¸€å€‹ library æŠŠ Query çš„é‚è¼¯åŒ…é€²å»ã€‚<strong>æˆ‘å€‘å”¯ä¸€éœ€è¦çš„é¡å¤–æœå‹™å°±æ˜¯ index workerï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢é‚£å€‹æˆ‘å€‘æŠŠ routing + querying å¯«æˆ library çš„ä½¿ç”¨è€…</strong>ï¼Œå¯¦éš›çš„ API ä¾‹å­å°±æ˜¯ä¸‹é¢çš„ codeã€‚</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>results <span style=color:#f92672>=</span> router<span style=color:#f92672>.</span>search(SearchQuery(
</span></span><span style=display:flex><span>  guild_id<span style=color:#f92672>=</span><span style=color:#ae81ff>112233445566778899</span>,
</span></span><span style=display:flex><span>  content<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;hey jake&#34;</span>,
</span></span><span style=display:flex><span>  channel_ids<span style=color:#f92672>=</span>[<span style=color:#ae81ff>166705234528174080</span>, <span style=color:#ae81ff>228695132507996160</span>]
</span></span><span style=display:flex><span>))
</span></span><span style=display:flex><span>results_with_context <span style=color:#f92672>=</span> gather_results(results, context_size<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span>)
</span></span></code></pre></div><p>Queueing ä¸€å‰‡è¨Šæ¯ç”¨ä¾† indexed/deleted</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e># When a message was created or updated:</span>
</span></span><span style=display:flex><span>broker<span style=color:#f92672>.</span>enqueue_message(message)
</span></span><span style=display:flex><span><span style=color:#75715e># When a message was deleted:</span>
</span></span><span style=display:flex><span>broker<span style=color:#f92672>.</span>enqueue_delete(message)
</span></span></code></pre></div><p>Bulk indexing çš„ code (è¢« worker åŸ·è¡Œ)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>gather_messages</span>(num_to_gather<span style=color:#f92672>=</span><span style=color:#ae81ff>100</span>):
</span></span><span style=display:flex><span>  messages <span style=color:#f92672>=</span> []
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>while</span> len(messages) <span style=color:#f92672>&lt;</span> num_to_gather:
</span></span><span style=display:flex><span>    messages<span style=color:#f92672>.</span>append(broker<span style=color:#f92672>.</span>pop_message())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>return</span> messages
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> <span style=color:#66d9ef>True</span>:
</span></span><span style=display:flex><span>  messages <span style=color:#f92672>=</span> gather_messages()
</span></span><span style=display:flex><span>  router<span style=color:#f92672>.</span>index_messages(messages)
</span></span></code></pre></div><p>æ¥è‘—å°æ–¼ historical messagesï¼Œæœƒæ˜¯ä»¥ job ç‚ºå–®ä½ä¸€å€‹ä¸€å€‹åºåˆ— indexï¼Œå¯¦éš›ä¸Šæœƒç¶­è­·ä¸€å€‹ cursor ç„¶å¾Œä»¥ 500 å‰‡ messages ç‚ºå–®ä½é€²è¡Œè™•ç†ã€‚è™•ç†å®Œæˆä¹‹å¾Œæœƒå›å‚³ä¸‹ä¸€å€‹ cursor ç›´åˆ°æ‰€æœ‰ historical messages éƒ½è¢« indexã€‚</p><p>ç‚ºäº†åŠ å¿«å¤§å‹ server (é€™è£¡æˆ‘æƒ³èªæ„æŒ‡çš„æ˜¯æˆ‘å€‘ç”¨çš„ Discord serverï¼Œä¸æ˜¯ä»–å€‘çš„ Application Server)ï¼Œhistorical indexing æœ‰å…©å€‹éšæ®µï¼š</p><ol><li><a href>initial</a>ï¼šindexes æœ€è¿‘ä¸ƒå¤©çš„è¨Šæ¯ï¼Œé¦¬ä¸Šçµ¦ user ç”¨</li><li><a href>deep</a>ï¼šæ‰€æœ‰çš„æ­·å²è¨Šæ¯ï¼Œä½†æ˜¯å„ªå…ˆæ€§æ¯”è¼ƒä½</li></ol><p>åŸ·è¡Œçš„ code å¤§æ¦‚é•·çš„åƒä»¥ä¸‹ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a6e22e>@task</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>job_task</span>(current_job)
</span></span><span style=display:flex><span>  <span style=color:#75715e># .process returns the next job to execute, or None if there are no more jobs to execute.</span>
</span></span><span style=display:flex><span>  next_job <span style=color:#f92672>=</span> current_job<span style=color:#f92672>.</span>process(router)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> next_job:
</span></span><span style=display:flex><span>    job_task<span style=color:#f92672>.</span>delay(next_job, priority<span style=color:#f92672>=</span>LOW <span style=color:#66d9ef>if</span> next_job<span style=color:#f92672>.</span>deep <span style=color:#66d9ef>else</span> NORMAL)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>initial_job <span style=color:#f92672>=</span> HistoricalIndexJob(guild_id<span style=color:#f92672>=</span><span style=color:#ae81ff>112233445566778899</span>)
</span></span><span style=display:flex><span>job_task<span style=color:#f92672>.</span>delay(initial_job) 
</span></span></code></pre></div><h1 id=å¯¦éš›åœ¨-production-çš„éç¨‹><strong>å¯¦éš›åœ¨ Production çš„éç¨‹</strong></h1><h2 id=åˆå§‹åŒ–å¯¦é©—><strong>åˆå§‹åŒ–å¯¦é©—</strong></h2><p>æœ€ç²¾é‡‡çš„å¯¦æˆ°éƒ¨åˆ†ä¾†æ‹‰ï¼Œæˆ‘å€‘æ ¹æ“šä»¥ä¸Šçš„è¨­è¨ˆï¼Œä¸€é–‹å§‹å…ˆé–‹ single Elasticsearch cluster (åªæœ‰ 3 å€‹ Nodes)ï¼Œç„¶å¾Œéƒ¨å±¬ index workersï¼Œç„¶å¾Œæ’ç¨‹æœ€å¤§çš„ 1000 å€‹ä½¿ç”¨è€…çš„ servers ä¾† indexï¼Œé€™å€‹éšæ®µæ˜¯åšå¯¦é©—ï¼Œæˆ‘å€‘æœƒä»”ç´°ç ”ç©¶ metricsï¼Œæˆ‘å€‘æ³¨æ„åˆ°å…©ä»¶äº‹æƒ…ï¼š</p><ol><li><a href>CPU ä½¿ç”¨æ¯”é æœŸçš„é«˜</a></li><li><a href>Disk ä½¿ç”¨æˆé•·å¤ªå¿«</a></li></ol><p>è·‘ä¸€æ®µæ™‚é–“ä¹‹å¾Œï¼ŒDisk å¿«æ²’ç©ºé–“äº†ï¼Œæˆ‘å€‘å–æ¶ˆäº† index çš„éç¨‹ï¼Œäº‹æƒ…çœŸçš„æ€ªæ€ªçš„â€¦â€¦</p><p>çµæœç¬¬äºŒå¤©ä¸Šç­å›ä¾†ï¼Œ<strong>æˆ‘å€‘ç™¼ç¾ç¥å¥‡çš„äº‹æƒ… Disk ç¸®å°äº†ï¼ï¼æˆ‘å€‘é–‹å§‹æ‡·ç–‘æ˜¯ä¸æ˜¯ Elasticsearch æŠŠæˆ‘å€‘çš„è³‡æ–™ä¸Ÿäº†ï¼Œä½†æ˜¯æ‰“ä¸€ä¸‹ API ä¸åƒ…æ­£ç¢ºè€Œä¸”è¶…ç´šå¿«ï¼ç‚ºå•¥ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</strong></p><h3 id=disk-æˆé•·é‡><strong>Disk æˆé•·é‡</strong></h3><p><img src=/images/discord-fulltext_0.png alt></p><h3 id=cpu-ä½¿ç”¨ç‡><strong>CPU ä½¿ç”¨ç‡</strong></h3><p><img src=/images/discord-fulltext_1.png alt></p><h2 id=ç ”ç©¶çš„ç²¾ç¥><strong>ç ”ç©¶çš„ç²¾ç¥</strong></h2><p>åœ¨ç ”ç©¶äº†ä¸€ä¸‹ä¹‹å¾Œï¼Œæˆ‘å€‘æå‡ºä¸€å€‹ <strong>å‡èªª</strong>ï¼š<a href>é è¨­æƒ…æ³ Elasticsearch æœƒä»¥æ¯ 1 ç§’ç‚ºå–®ä½ï¼Œç„¶å¾Œåˆ·æ–° indexï¼Œé€™å¯ä»¥æä¾› â€œnear real-timeâ€ æœå°‹çš„èƒ½åŠ›ï¼Œè€Œä¸”åŒæ™‚æœƒæŠŠæ•¸åƒå€‹ index æ”¾åˆ° buffer ä¸­ Lucene segmentã€‚æ™šä¸Š Elasticsearch å°±æœƒå·å·åˆä½µ segmentï¼Œæ‰€ä»¥ Disk å°±æœƒç¸®æ¸›å®¹é‡ã€‚</a></p><p>è¦æ¸¬è©¦é€™å€‹å‡èªªä¹Ÿå¾ˆç°¡å–®ï¼Œå°±ç›´æ¥æŠŠæ‰€æœ‰å…ˆå‰çš„ index ä¸Ÿæ‰ï¼Œç„¶å¾ŒæŠŠåˆ·æ–°çš„é–“éš”èª¿è¶…å¤§ï¼ŒCPU ç¬é–“æ­¸é›¶ï¼ŒDisk ä¹Ÿæ²’æœ‰çˆ†ç‚¸æ€§å¢é•·ï¼Œå¤ªç¥æ‹‰ï¼</p><h3 id=disk-æˆé•·é‡-èª¿æ•´åˆ·æ–°åƒæ•¸éå¾Œ><strong>Disk æˆé•·é‡ (èª¿æ•´åˆ·æ–°åƒæ•¸éå¾Œ)</strong></h3><p><img src=/images/discord-fulltext_2.png alt></p><h3 id=cpu-ä½¿ç”¨ç‡-èª¿æ•´åˆ·æ–°åƒæ•¸éå¾Œ><strong>CPU ä½¿ç”¨ç‡ (èª¿æ•´åˆ·æ–°åƒæ•¸éå¾Œ)</strong></h3><p><img src=/images/discord-fulltext_3.png alt></p><h2 id=æ›´æ–°çš„ç…©æƒ±><strong>æ›´æ–°çš„ç…©æƒ±</strong></h2><p>é¡¯ç„¶ï¼ŒElasticsearch å…§å»ºçš„ near real-time index æˆ‘å€‘æ²’æœ‰è¦ç”¨ã€‚å¯èƒ½ä¸€å€‹ server å¥½å¹¾å€‹å°æ™‚éƒ½æ²’æœ‰ä¸€æ¬¡æŸ¥è©¢ï¼Œæˆ‘å€‘å¿…é ˆåœ¨ Application Layer è¨­è¨ˆä¸€å±¤æ›´æ–°ç­–ç•¥ã€‚<a href>æˆ‘å€‘ç”¨ Redis Expiring hashmap åšåˆ°é€™é»ï¼Œç”±æ–¼æœ¬èº« server å’Œ Elasticsearch ä¸€èµ·è¢« shardï¼Œæˆ‘å€‘å¯ä»¥å¾ˆæ–¹ä¾¿çš„æŒçºŒè¿½è¹¤æ›´æ–°ç‹€æ…‹ã€‚</a></p><p>å¯¦è¸ä¸Šä¹Ÿå¾ˆç°¡å–®ï¼Œ<a href>Redis key å°±æ˜¯ prefix + shard_key çš„ Hashmap ç®¡ç† guild_id â‡’ sentinel valueï¼Œç”±æ­¤æ±ºå®šè¦ä¸è¦åˆ·æ–° index</a>ï¼Œä»¥ä¸‹æ˜¯å®Œæ•´çš„ lifecycleï¼š</p><h3 id=indexing-lifecycle><strong>Indexing lifecycle</strong></h3><ol><li><strong>å¾ Queue å– N å‰‡è¨Šæ¯</strong></li><li><strong>ç”¨ guild_id æ‰¾åˆ°éœ€è¦ route çš„ shard</strong></li><li><strong>åŸ·è¡Œ bulk insert</strong></li><li><strong>æ›´æ–° Redis mappings æ¨™è¨˜æˆ dirtyï¼Œä¸€å€‹å°æ™‚å¾Œå°±æœƒéæœŸ</strong></li></ol><h3 id=search-lifecycle><strong>Search lifecycle</strong></h3><ol><li><strong>æ ¹æ“š guild_id æ‰¾åˆ°è‡ªå·±éœ€è¦çš„æœå°‹çš„ shard</strong></li><li><strong>æª¢æŸ¥ Redis mappingï¼Œæ˜¯å¦è¦æŸ¥çš„ guild_id æ˜¯ dirty</strong></li><li><strong>å¦‚æœæ˜¯ dirty åˆ·æ–° Elasticsearch Indexï¼Œç„¶å¾Œæ¨™è¨˜æˆ clean</strong></li><li><strong>åŸ·è¡Œ query æœ¬èº«</strong></li></ol><p>ä½ å¯èƒ½å·²ç¶“ç™¼ç¾ï¼Œ<a href>æˆ‘å€‘è¨­è¨ˆæµç¨‹å·²ç¶“æœ‰åŒ…å«äº†åˆ·æ–°é‚è¼¯ï¼Œä¸éæˆ‘å€‘é‚„æ˜¯æœ‰è¨­è¨ˆæ¯å€‹å°æ™‚çš„è‡ªå‹•åˆ·æ–° indexã€‚ä¹Ÿå°±æ˜¯èªªå°±ç®— Redis æ›äº†ï¼Œæœ€å¤šä¸€å€‹å°æ™‚ä¹‹å¾Œï¼Œç³»çµ±å°±æœƒè‡ªå‹•ä¿®å¾©ã€‚</a></p><h1 id=the-future><strong>The Future</strong></h1><p>ç›®å‰ç‚ºæ­¢ï¼Œæˆ‘å€‘é‹è¡Œäº† <a href>14 nodes, 2 clusters ç”¨çš„æ©Ÿå™¨æ˜¯ n1-standard-8 instance (GCP)</a>ï¼Œéƒ½å¸¶æœ‰ <a href>1TB çš„ SSD</a>ã€‚ç¸½å…±çš„ <a href>document æœ‰ 26 billion</a>ã€‚å¢åŠ çš„é€Ÿåº¦å¤§ç´„<a href>æ¯ç§’ 30,000 messagesï¼ŒElasticsearch å¤§ç´„åªèŠ±äº† 5â€“15% CPUã€‚</a></p><p>æˆ‘å€‘çš„ library å¯ä»¥è®“æˆ‘å€‘è¼•é¬†çš„å¢åŠ  nodes éƒ½ä¸æ˜¯å•é¡Œï¼Œshard çœŸæ˜¯å‰å¤§çš„ç™¼æ˜é˜¿ï¼</p><p>è‡³æ–¼ç”šéº¼æ™‚å€™è¦æ“´å¼µæˆ‘å€‘çš„ clusterï¼Œæˆ‘å€‘åƒè€ƒå››å€‹ä¸»è¦æŒ‡æ¨™ï¼š</p><ol><li><strong><a href>heap_free</a></strong>ï¼šJVM å¦‚æœç™¼ç”Ÿäº† <strong>Stop-The-World GCï¼Œé‚£å«è¦è€ƒæ…®åŠ  node äº†</strong>ã€‚</li><li><strong><a href>disk_free</a></strong>ï¼šæ²’æœ‰ Disk ç©ºé–“ç•¶ç„¶å°±è¦åŠ  nodeï¼Œä¸éå–®ç´” Disk ä¸å¤ ç”¨ GCP å¯ä»¥è¼•é¬†çš„æ›æ©Ÿå™¨å¤§å°ï¼ŒGCP çœŸé¦™ã€‚</li><li><strong><a href>cpu_usage</a></strong>ï¼šCPU usage åœ¨å°–å³°æ™‚åˆ»éé«˜</li><li><strong><a href>io_wait</a></strong>ï¼šå¦‚æœ I/O æ“ä½œéæ–¼ç·©æ…¢çš„è©±</li></ol><h2 id=exampleunhealthy-cluster-ran-out-of-heap>Exampleï¼šUnhealthy Cluster (ran out of heap)</h2><h3 id=heap-free-mib><strong>Heap Free (MiB)</strong></h3><p><img src=/images/discord-fulltext_4.png alt></p><h3 id=time-spent-gcs><strong>Time Spent GC/s</strong></h3><p><img src=/images/discord-fulltext_5.png alt></p><h2 id=examplehealthy-cluster>Exampleï¼š<strong><strong>Healthy Cluster</strong></strong></h2><h3 id=heap-free-gib><strong>Heap Free (GiB)</strong></h3><p><img src=/images/discord-fulltext_6.png alt></p><h3 id=time-spent-gcs-1><strong>Time Spent GC/s</strong></h3><p><img src=/images/discord-fulltext_77.png alt></p><h1 id=çµè«–><strong>çµè«–</strong></h1><p>æˆªè‡³ç›®å‰ç‚ºæ­¢ï¼Œæˆ‘å€‘çš„ç³»çµ±éƒ½è¡¨ç¾çš„è¶…æ£’ï¼Œèº«ç‚ºä½¿ç”¨è€…çš„æˆ‘ä¹Ÿé€™éº¼è¦ºå¾— XDã€‚<a href>Elasticsearch å¾ 0 åˆ° 26 billion documents åŒ…å« 16,000 indicesï¼Œéƒ½æ²’æœ‰ç”šéº¼å•é¡Œ</a>ã€‚åœ¨æœªä¾†æˆ–è¨±æˆ‘å€‘æœƒè€ƒæ…®å¯«åœ¨ clusters ä¹‹é–“ migrate indicesï¼Œä»¥é˜²å‡ºç¾é‚£ç¨®è¶…ç´šå¤šè¨Šæ¯çš„ Discord serverï¼Œä¸éä½œè€…èªªç›®å‰ç‚ºæ­¢å¥½åƒæ²’æœ‰å¿…è¦æ‹‰ XDï¼Œæˆ‘å€‘çš„ sharding åšå¾—å¾ˆå¥½ã€‚</p><h1 id=æ„Ÿæƒ³><strong>æ„Ÿæƒ³</strong></h1><p>é€™éƒ¨åˆ†æˆ‘å°±å¯«å¯«æˆ‘è‡ªå·±çš„æ„Ÿæƒ³å§ï¼åœ¨ç ”ç©¶é€™ç¯‡æ–‡ç« æ™‚æˆ‘åŸæœ¬é æœŸæœƒæ²’å•¥å…§å®¹ï¼Œé˜¿ä¸å°± Elasticsearch é–‹ä¸‹å»å°±å¥½äº† XD ä¸éæ¯”æˆ‘æƒ³çš„ç²¾å½©è¨±å¤šï¼Œ<a href>ç”±æ–¼ Discord å·²ç¶“æ˜¯è¶…å¤§çš„ SaaSï¼Œå®Œå…¨ä¿¡ä»»ç¬¬ä¸‰æ–¹çš„ Infra æœ¬èº«å°±è˜Šå«äº†ä¸ç¢ºå®šæ€§å±æ©Ÿï¼Œç”¨è‡ªå·±å¯ä»¥æ§åˆ¶çš„ code å»ä½¿ç”¨ç¬¬ä¸‰æ–¹è»Ÿé«”é–‹ç™¼æœå‹™æ˜¯ä¸€å€‹æŠ˜è¡·çš„ç­–ç•¥ã€‚</a></p><p>å›åˆ°ä»¥å‰åœ¨å’Œå‘¨å¿—é è€å¸«å­¸åˆ†æ•£æ˜¯ç³»çµ±çš„æ™‚å€™ï¼Œç¬¬ä¸€ç« èªªåˆ†æ•£å¼ç³»çµ±æ˜¯é æºé€šé”æˆçš„ï¼Œé€™ç¯‡æ–‡ç« ç®—æ˜¯çµ¦æˆ‘ä¸€å€‹å¾ˆå¤§çš„å¯¦éš›æ¡ˆä¾‹è§£èªªï¼Œåœ¨æ–‡ç« è£¡é¢ä½ æ²’æœ‰çœ‹åˆ°ä¸€å †è¶…ç¡¬çš„ Algorithmï¼Œè€Œæ˜¯å¦‚ä½•ç²¾å¦™çš„æ‰“é€ ç”¢å“ï¼Œç”¨çš„å·¥å…·ä¹Ÿå°±æ˜¯ Queue å’Œ Worker è€Œå·²ï¼Œçœ‹å®Œè¦ºå¾—æ„Ÿå‹• >///&lt;ã€‚</p></section><div class=post-tags></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/tachunwu rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a></div><div class=footer-info>2023 ğŸ’  Â© Tachunn | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script async src="https://www.googletagmanager.com/gtag/js?id=G-2LYZQ778V0"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2LYZQ778V0")</script><script>feather.replace()</script></div></body></html>