<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>&lt;How We Went All In on ï¼šsqlc/pgx for Postgres + Go> - Tachunn Publication</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="è¨»è¨˜ï¼šä½œè€…æœ¬äººæœ‰æ”å½±çš„èˆˆè¶£ï¼Œæˆ‘æ‹¿ä»–çš„ä¸€å¼µç›¸ç‰‡ç•¶å°é¢ XD
Index å°è¨€ å‰è¨€ Tour database/sql lib/pq pgx go-pg gorm Research Queries as strings ORMs sqlc Codegen pgx support appears Caveats and workarounds Summary and future å°è¨€ é€™ç¯‡æ–‡ç« æ˜¯å°ˆç‚º Go é–‹ç™¼è€…å¯«çš„ï¼Œä¸»è¦ç¿»è­¯ <How We Went All In on sqlc/pgx for Postgres + Go>ï¼Œé€™ç¯‡æ–‡ç« çš„ä½œè€…æœ¬èº«åœ¨ Heroku å·¥ä½œéä¹Ÿåœ¨ stripe å·¥ä½œéï¼ŒåŒæ™‚ä¹Ÿæ˜¯æå‡º Idempotent Key API çš„äººã€‚
ç¾åœ¨ä»–åœ¨ Crunchy Data é–‹ç™¼ platform APIï¼Œå°æ–¼ Postgres å’Œ Go éƒ½ç®—æ˜¯éå¸¸æœ‰ç¶“é©—çš„å°ˆå®¶ï¼Œé€™ç¯‡æ–‡ç« æœƒåˆ†äº«ä¸€äº›ä»–å°ç•¶å‰ç”Ÿæ…‹ç’°å¢ƒ Go å¦‚ä½•æ“ä½œ Postgres çš„ä¸€äº›çœ‹æ³•ã€‚
å‰è¨€ å¹¾å€‹æœˆçš„å¯¦é©—å’Œç ”ç©¶å¾Œï¼Œæˆ‘å€‘è·‘äº†ä¸€äº› DB-dependent Go appï¼Œæˆ‘å€‘å¾—åˆ°ä¸€å€‹çµè«–å°±æ˜¯ sqlc å¯ä»¥èªªæ˜¯æœ€å¥½çš„æ‹¿ä¾†ä½¿ç”¨çš„ Postgres (å¯ä»¥èƒ½å…¶ä»– databases ä¹Ÿæ˜¯)ã€‚è€Œä¸”åœ¨ Go code ä¹Ÿå¾ˆå®¹æ˜“ä½¿ç”¨ï¼Œä»¥ä¸‹å°±è®“ä¾†ä»‹ç´¹ä¸€ä¸‹æˆ‘å€‘çš„ç ”ç©¶å§ï¼"><meta property="og:image" content><meta property="og:title" content="<How We Went All In on ï¼šsqlc/pgx for Postgres + Go>"><meta property="og:description" content="è¨»è¨˜ï¼šä½œè€…æœ¬äººæœ‰æ”å½±çš„èˆˆè¶£ï¼Œæˆ‘æ‹¿ä»–çš„ä¸€å¼µç›¸ç‰‡ç•¶å°é¢ XD
Index å°è¨€ å‰è¨€ Tour database/sql lib/pq pgx go-pg gorm Research Queries as strings ORMs sqlc Codegen pgx support appears Caveats and workarounds Summary and future å°è¨€ é€™ç¯‡æ–‡ç« æ˜¯å°ˆç‚º Go é–‹ç™¼è€…å¯«çš„ï¼Œä¸»è¦ç¿»è­¯ <How We Went All In on sqlc/pgx for Postgres + Go>ï¼Œé€™ç¯‡æ–‡ç« çš„ä½œè€…æœ¬èº«åœ¨ Heroku å·¥ä½œéä¹Ÿåœ¨ stripe å·¥ä½œéï¼ŒåŒæ™‚ä¹Ÿæ˜¯æå‡º Idempotent Key API çš„äººã€‚
ç¾åœ¨ä»–åœ¨ Crunchy Data é–‹ç™¼ platform APIï¼Œå°æ–¼ Postgres å’Œ Go éƒ½ç®—æ˜¯éå¸¸æœ‰ç¶“é©—çš„å°ˆå®¶ï¼Œé€™ç¯‡æ–‡ç« æœƒåˆ†äº«ä¸€äº›ä»–å°ç•¶å‰ç”Ÿæ…‹ç’°å¢ƒ Go å¦‚ä½•æ“ä½œ Postgres çš„ä¸€äº›çœ‹æ³•ã€‚
å‰è¨€ å¹¾å€‹æœˆçš„å¯¦é©—å’Œç ”ç©¶å¾Œï¼Œæˆ‘å€‘è·‘äº†ä¸€äº› DB-dependent Go appï¼Œæˆ‘å€‘å¾—åˆ°ä¸€å€‹çµè«–å°±æ˜¯ sqlc å¯ä»¥èªªæ˜¯æœ€å¥½çš„æ‹¿ä¾†ä½¿ç”¨çš„ Postgres (å¯ä»¥èƒ½å…¶ä»– databases ä¹Ÿæ˜¯)ã€‚è€Œä¸”åœ¨ Go code ä¹Ÿå¾ˆå®¹æ˜“ä½¿ç”¨ï¼Œä»¥ä¸‹å°±è®“ä¾†ä»‹ç´¹ä¸€ä¸‹æˆ‘å€‘çš„ç ”ç©¶å§ï¼"><meta property="og:type" content="article"><meta property="og:url" content="https://tachunwu.github.io/posts/sqlc/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-02-19T16:58:55+08:00"><meta property="article:modified_time" content="2023-02-19T16:58:55+08:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="<How We Went All In on ï¼šsqlc/pgx for Postgres + Go>"><meta name=twitter:description content="è¨»è¨˜ï¼šä½œè€…æœ¬äººæœ‰æ”å½±çš„èˆˆè¶£ï¼Œæˆ‘æ‹¿ä»–çš„ä¸€å¼µç›¸ç‰‡ç•¶å°é¢ XD
Index å°è¨€ å‰è¨€ Tour database/sql lib/pq pgx go-pg gorm Research Queries as strings ORMs sqlc Codegen pgx support appears Caveats and workarounds Summary and future å°è¨€ é€™ç¯‡æ–‡ç« æ˜¯å°ˆç‚º Go é–‹ç™¼è€…å¯«çš„ï¼Œä¸»è¦ç¿»è­¯ <How We Went All In on sqlc/pgx for Postgres + Go>ï¼Œé€™ç¯‡æ–‡ç« çš„ä½œè€…æœ¬èº«åœ¨ Heroku å·¥ä½œéä¹Ÿåœ¨ stripe å·¥ä½œéï¼ŒåŒæ™‚ä¹Ÿæ˜¯æå‡º Idempotent Key API çš„äººã€‚
ç¾åœ¨ä»–åœ¨ Crunchy Data é–‹ç™¼ platform APIï¼Œå°æ–¼ Postgres å’Œ Go éƒ½ç®—æ˜¯éå¸¸æœ‰ç¶“é©—çš„å°ˆå®¶ï¼Œé€™ç¯‡æ–‡ç« æœƒåˆ†äº«ä¸€äº›ä»–å°ç•¶å‰ç”Ÿæ…‹ç’°å¢ƒ Go å¦‚ä½•æ“ä½œ Postgres çš„ä¸€äº›çœ‹æ³•ã€‚
å‰è¨€ å¹¾å€‹æœˆçš„å¯¦é©—å’Œç ”ç©¶å¾Œï¼Œæˆ‘å€‘è·‘äº†ä¸€äº› DB-dependent Go appï¼Œæˆ‘å€‘å¾—åˆ°ä¸€å€‹çµè«–å°±æ˜¯ sqlc å¯ä»¥èªªæ˜¯æœ€å¥½çš„æ‹¿ä¾†ä½¿ç”¨çš„ Postgres (å¯ä»¥èƒ½å…¶ä»– databases ä¹Ÿæ˜¯)ã€‚è€Œä¸”åœ¨ Go code ä¹Ÿå¾ˆå®¹æ˜“ä½¿ç”¨ï¼Œä»¥ä¸‹å°±è®“ä¾†ä»‹ç´¹ä¸€ä¸‹æˆ‘å€‘çš„ç ”ç©¶å§ï¼"><script src=https://tachunwu.github.io/js/feather.min.js></script>
<link href=https://tachunwu.github.io/css/fonts.2c2227b81b1970a03e760aa2e6121cd01f87c88586803cbb282aa224720a765f.css rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://tachunwu.github.io/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css></head><body><div class=content><header><script async src="https://www.googletagmanager.com/gtag/js?id=G-2LYZQ778V0"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2LYZQ778V0")</script><div class=main><a href=https://tachunwu.github.io/>Tachunn Publication</a></div><nav><a href=/>Home</a>
<a href=/posts>All posts</a>
<a href=/about>About</a>
<a href=/tags>Tags</a></nav></header><main><article><div class=title><h1 class=title>&lt;How We Went All In on ï¼šsqlc/pgx for Postgres + Go></h1><div class=meta>Posted on Feb 19, 2023</div></div><section class=body><p><img src=/images/sqlc_head.png alt>
<em>è¨»è¨˜ï¼šä½œè€…æœ¬äººæœ‰æ”å½±çš„èˆˆè¶£ï¼Œæˆ‘æ‹¿ä»–çš„ä¸€å¼µç›¸ç‰‡ç•¶å°é¢ XD</em></p><div><h2>Index</h2><nav id=TableOfContents><ol><li><a href=#å°è¨€>å°è¨€</a></li><li><a href=#å‰è¨€>å‰è¨€</a></li><li><a href=#tour>Tour</a><ol><li><a href=#databasesql>database/sql</a></li><li><a href=#libpqhttpsgithubcomlibpq><a href=https://github.com/lib/pq>lib/pq</a></a></li><li><a href=#pgxhttpsgithubcomjackcpgx><a href=https://github.com/jackc/pgx>pgx</a></a></li><li><a href=#go-pghttpsgithubcomgo-pgpg><a href=https://github.com/go-pg/pg>go-pg</a></a></li><li><a href=#gormhttpsgormio><a href=https://gorm.io/>gorm</a></a></li></ol></li><li><a href=#research>Research</a><ol><li><a href=#queries-as-strings>Queries as strings</a></li><li><a href=#orms>ORMs</a></li></ol></li><li><a href=#sqlchttpswwwnotionsohow-we-went-all-in-on-pgx-for-postgres-go-1b1b1b242db14317bf8de9bda27c0fe8><a href=https://www.notion.so/How-We-Went-All-In-on-pgx-for-Postgres-Go-1b1b1b242db14317bf8de9bda27c0fe8>sqlc</a></a><ol><li><a href=#codegen>Codegen</a></li><li><a href=#pgx-support-appears>pgx support appears</a></li><li><a href=#caveats-and-workarounds>Caveats and workarounds</a></li></ol></li><li><a href=#summary-and-future>Summary and future</a></li></ol></nav></div><h1 id=å°è¨€>å°è¨€</h1><p>é€™ç¯‡æ–‡ç« æ˜¯å°ˆç‚º Go é–‹ç™¼è€…å¯«çš„ï¼Œä¸»è¦ç¿»è­¯ &lt;<a href=https://brandur.org/sqlc>How We Went All In on sqlc/pgx for Postgres + Go</a>>ï¼Œ<strong>é€™ç¯‡æ–‡ç« çš„ä½œè€…æœ¬èº«åœ¨ Heroku å·¥ä½œéä¹Ÿåœ¨ stripe å·¥ä½œéï¼ŒåŒæ™‚ä¹Ÿæ˜¯æå‡º Idempotent Key API çš„äºº</strong>ã€‚</p><p>ç¾åœ¨ä»–åœ¨ <a href=https://www.crunchydata.com/>Crunchy Data</a> é–‹ç™¼ platform APIï¼Œå°æ–¼ Postgres å’Œ Go éƒ½ç®—æ˜¯éå¸¸æœ‰ç¶“é©—çš„å°ˆå®¶ï¼Œé€™ç¯‡æ–‡ç« æœƒåˆ†äº«ä¸€äº›ä»–å°ç•¶å‰ç”Ÿæ…‹ç’°å¢ƒ Go å¦‚ä½•æ“ä½œ Postgres çš„ä¸€äº›çœ‹æ³•ã€‚</p><h1 id=å‰è¨€>å‰è¨€</h1><p>å¹¾å€‹æœˆçš„å¯¦é©—å’Œç ”ç©¶å¾Œï¼Œ<strong>æˆ‘å€‘è·‘äº†ä¸€äº› DB-dependent Go appï¼Œæˆ‘å€‘å¾—åˆ°ä¸€å€‹çµè«–å°±æ˜¯ <a href=https://github.com/kyleconroy/sqlc>sqlc</a> å¯ä»¥èªªæ˜¯æœ€å¥½çš„æ‹¿ä¾†ä½¿ç”¨çš„ Postgres</strong> (å¯ä»¥èƒ½å…¶ä»– databases ä¹Ÿæ˜¯)ã€‚è€Œä¸”åœ¨ Go code ä¹Ÿå¾ˆå®¹æ˜“ä½¿ç”¨ï¼Œä»¥ä¸‹å°±è®“ä¾†ä»‹ç´¹ä¸€ä¸‹æˆ‘å€‘çš„ç ”ç©¶å§ï¼</p><h1 id=tour>Tour</h1><p>ç•¶ç„¶æˆ‘å€‘æœƒç ”ç©¶å¾ˆå¤šåœ¨ Go ecosystem å¾ˆæœ‰åçš„ Projectsï¼š</p><h2 id=databasesql>database/sql</h2><p>Go built-in çš„ database packageï¼Œæˆ‘å¾ˆå¾ˆå¤šäººæœƒåŒæ„æˆ‘ï¼Œ<strong>æœ€å¥½é¿å…ä½¿ç”¨å®ƒã€‚å° database ä¾†èªªæ˜¯é›£ä»¥é æ¸¬çš„ï¼Œè€Œä¸”ä¸æ”¯æ´ä¸€äº› Postgres-specific çš„åŠŸèƒ½ã€‚</strong></p><h2 id=libpqhttpsgithubcomlibpq><a href=https://github.com/lib/pq>lib/pq</a></h2><p>ä¸€å€‹æ—©æœŸåœ¨ Go System çš„ Postgres å°ˆæ¡ˆï¼Œé›–ç„¶æœ‰å®ƒçš„è¼ç…Œæ™‚æœŸï¼Œ<strong>ä½†æ˜¯ç¾åœ¨çš„ç¶­è­·é‡å·²ç¶“å¾ˆå°‘äº†ã€‚</strong></p><h2 id=pgxhttpsgithubcomjackcpgx><a href=https://github.com/jackc/pgx>pgx</a></h2><p><strong>é€™å€‹ package å¯«å¾—éå¸¸å¥½</strong>ï¼Œå° Postgres æä¾›éå¸¸å¾¹åº•çš„ full-featured, performant connectionsã€‚<strong>ç„¶è€Œé€™å€‹å°ˆæ¡ˆæ­¦æ–·çš„ä¸æä¾› ORM ç›¸é—œçš„åŠŸèƒ½ï¼Œé™¤äº†åŸºæœ¬çš„ query interface æ ¹æœ¬æ²’æœ‰æä¾›ä»€éº¼åŠŸèƒ½ã€‚</strong></p><p>å°±åƒ <code>database/sql</code> å°‡ database å’Œ stuct é›†åˆå’Œæ˜¯éå¸¸ç—›è‹¦çš„äº‹æƒ…ï¼Œä½ ä¸åªå¿…éœ€è¦æ‰‹å‹•æ¨™è¨˜ target fields ä»¤äººä½œå˜”çš„å­—ä¸²ï¼Œé‚„éœ€è¦æ‰‹å‹• <code>Scan</code> ä»–å€‘é€²å» struct å…§éƒ¨ï¼Œã€‚</p><h3 id=scanyhttpsgithubcomgeorgysavvascany><a href=https://github.com/georgysavva/scany>scany</a></h3><p>Scany åœ¨ pgx ä¸Šé¢åŠ äº†ä¸€äº›è®“ä½ ä½¿ç”¨ pgx ç”Ÿæ´»æ›´å¿«æ¨‚çš„åŠŸèƒ½ï¼Œä½†æ˜¯ä½ é‚„æ˜¯éœ€è¦ç¾…åˆ— field names åœ¨ <code>SELECT â€¦</code> ä¹‹ä¸­ï¼Œ<strong>æ‰€ä»¥åªç®—æä¾›äº†åŠå€‹æ¨£æ¿ã€‚</strong></p><h2 id=go-pghttpsgithubcomgo-pgpg><a href=https://github.com/go-pg/pg>go-pg</a></h2><p><strong>æˆ‘å€‹äººä»¥å‰æœ‰ç”¨éé€™å€‹ Projectï¼Œé€™å…¶å¯¦æ˜¯å€‹è »å¥½ç”¨çš„ Postgres-specific ORM</strong>ã€‚ä¸‹é¢æˆ‘å€‘æœƒèŠ±ç¯‡å¹…èªªæ˜ ORMs å° Go çš„ç¼ºé»ï¼Œ<strong>é‚„æœ‰ go-pg çš„å¦ä¸€å€‹ç¼ºé»å°±æ˜¯å®ƒæ™‚åšäº†è‡ªå·±çš„ driverï¼Œä¸èƒ½ç›¸å®¹ pgxã€‚</strong></p><h3 id=bunhttpsbunuptracedevguidepg-migrationhtmlnew-features><a href=https://bun.uptrace.dev/guide/pg-migration.html#new-features>Bun</a></h3><p>go-pg é‚„æœ‰è¢«æ”¶éŒ„é€²å» Bun ä¾† maintainï¼Œé‡å¯«äº† go-pg rewrite ä½†æ˜¯å»ä½¿ç”¨ non-Postgres databasesï¼Œè‡ªç„¶ä¸åœ¨æœ¬ç¯‡çš„è¨è«–ç¯„åœå…§ã€‚</p><h2 id=gormhttpsgormio><a href=https://gorm.io/>gorm</a></h2><p>ä¸€æ¨£å’Œ go-pg å·®ä¸å¤šç‰¹æ€§ï¼Œä½†æ˜¯ä¸åªæ˜¯é‡å° Postgresï¼Œé‚„åŒ…é‚„äº†å…¶ä»–çš„ databaseã€‚ä½ å¯ä»¥ä½¿ç”¨ pgx ç•¶ driverï¼Œä½†æ˜¯å¤±å»äº†å¾ˆå¤š Postgres featuresã€‚</p><h1 id=research>Research</h1><h2 id=queries-as-strings>Queries as strings</h2><p>å°æ–¼åŸç”Ÿ <code>database/sql</code> å’Œ <code>pgx</code> æœ€å¤§çš„ç¼ºé»å°±æ˜¯ SQL queries æ˜¯ stringsï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>name</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>weight</span> <span style=color:#66d9ef>int64</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>QueryRow</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>&#34;SELECT name, weight FROM widgets WHERE id = $1&#34;</span>, <span style=color:#ae81ff>42</span>).
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Scan</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>name</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>weight</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>	<span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>weight</span>)
</span></span></code></pre></div><p>ç•¶ç„¶é€™äº› queries å¾ˆç°¡å–®ï¼Œ<strong>ä½†æ˜¯å¯¦éš›çš„æŸ¥è©¢å…¶å¯¦æ²’æœ‰ä»€éº¼ä¿¡å¿ƒå®ƒå€‘å¯ä»¥ workã€‚compiler åªæœƒçœ‹åˆ°ä¸€å€‹ string ç„¶å¾Œä½ é‚„éœ€è¦äº›é¡å¤–å¾—æ¸¬è©¦å»é©—è­‰ä»–å€‘ã€‚</strong></p><p>æ›´ç³Ÿå‰›çš„äº‹æƒ…æ˜¯ç•¶ä½ åœ¨å¯«ä¸€å€‹å¤§å‹çš„ Applicationï¼Œéœ€è¦å»æ··åˆä¸€äº› models ä¾†æ¸›å°‘ code çš„é‡è¤‡ç‡ã€‚ä½ å¯èƒ½é–‹å§‹å°‡é€™äº› string é»åœ¨ä¸€èµ·ï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>conn</span>.<span style=color:#a6e22e>QueryRow</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#e6db74>`SELECT `</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>scanTeamFields</span> <span style=color:#f92672>+</span> <span style=color:#960050;background-color:#1e0010>`</span> <span style=color:#f92672>...</span>)
</span></span></code></pre></div><h2 id=orms>ORMs</h2><p>ORMs åƒæ˜¯ go-pg æ··åˆäº†ä¸€äº› typeï¼ŒæŸç¨®ç¨‹åº¦ä¸Šé¿å…äº†éŒ¯èª¤ï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>story</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>Story</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>db</span>.<span style=color:#a6e22e>Model</span>(<span style=color:#a6e22e>story</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Relation</span>(<span style=color:#e6db74>&#34;Author&#34;</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Where</span>(<span style=color:#e6db74>&#34;story.id = ?&#34;</span>, <span style=color:#a6e22e>story1</span>.<span style=color:#a6e22e>Id</span>).
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Select</span>()
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    panic(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>ç„¶è€Œæ²’æœ‰ generics (ç¾åœ¨ç‰ˆæœ¬å·²ç¶“æœ‰äº† XD)ï¼ŒGo çš„ type system èƒ½æä¾›çš„ä¹Ÿåªæœ‰é€™æ¨£ï¼Œå‹™å¯¦ä¸Š compiler ç„¡æ³•æª¢æŸ¥åˆ°æˆ‘å€‘é€£æ¥æ›´å¤šå­—ä¸²çš„æƒ…å¢ƒã€‚</p><p>åœ¨ä¸Šé¢çš„ codeï¼Œ<code>Model()</code>å›å‚³äº†ä¸€å€‹ <code>*Query</code> ç‰©ä»¶ã€‚<code>Relation()</code> ä¸€æ¨£ä¹Ÿå›å‚³ <code>*Query</code> ç‰©ä»¶ã€<code>Where()</code> ä¹Ÿä¸€æ¨£ã€‚pg-go çš„ç¢ºæœ‰åšä¸€äº›å„ªåŒ–ï¼Œ<strong>ä½†æ˜¯é€™äº›éŒ¯èª¤åªèƒ½èƒ½åœ¨ runtime è¢«ç™¼ç¾ã€‚</strong></p><p><strong>ORMs é‚„æœ‰ä¸€å€‹å•é¡Œï¼Œèˆ‡å¤§å¤šæ•¸ç¿’æ…£ SQL å¾—äººé‚„éœ€è¦æ™‚é–“å»é©æ‡‰ ORMï¼Œæ„å‘³è‘—ä½ å¯èƒ½èŠ±æ•´å¤©çš„æ™‚é–“åœ¨çœ‹æ–‡ä»¶ï¼Œåªæ˜¯ç‚ºäº†ç¿»è­¯ SQL ORM ä¹‹ä¸­ã€‚ç°¡å–®çš„ queries é›–ç„¶ä¸ç”¨èŠ±å¤ªå¤šæ™‚é–“ï¼Œä½†æ˜¯è©¦è‘—æƒ³æƒ³çœ‹å¦‚æœè¦è™•ç† upsert æˆ–æ˜¯ CTE ä¹‹é¡çš„åŠŸèƒ½ã€‚</strong></p><h1 id=sqlchttpswwwnotionsohow-we-went-all-in-on-pgx-for-postgres-go-1b1b1b242db14317bf8de9bda27c0fe8><a href=https://www.notion.so/How-We-Went-All-In-on-pgx-for-Postgres-Go-1b1b1b242db14317bf8de9bda27c0fe8>sqlc</a></h1><p>åœ¨ä»¥ä¸Šçš„ç ”ç©¶å¾Œï¼Œæˆ‘å€‘ç™¼ç¾äº† sqlcã€‚ä½ å¯ä»¥ç°¡å–®çš„å¯« <code>*.sql</code> filesï¼Œå…¶ä¸­å¯ä»¥åŒ…æ¶µ table å’Œ queryï¼Œåªéœ€è¦åŠ ç°¡å–®çš„è¨»è§£ï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#66d9ef>CREATE</span> <span style=color:#66d9ef>TABLE</span> authors (
</span></span><span style=display:flex><span>  id   BIGSERIAL <span style=color:#66d9ef>PRIMARY</span> <span style=color:#66d9ef>KEY</span>,
</span></span><span style=display:flex><span>  name text      <span style=color:#66d9ef>NOT</span> <span style=color:#66d9ef>NULL</span>,
</span></span><span style=display:flex><span>  bio  text
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>-- name: CreateAuthor :one
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> authors (
</span></span><span style=display:flex><span>  name, bio
</span></span><span style=display:flex><span>) <span style=color:#66d9ef>VALUES</span> (
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>1</span>, <span style=color:#960050;background-color:#1e0010>$</span><span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>RETURNING <span style=color:#f92672>*</span>; 
</span></span></code></pre></div><p>ä¹‹å¾Œä½ å¯ä»¥ç”¨ <code>sqlc generate</code> è‡ªå‹•ç”¢ç”Ÿ Go codeï¼Œä½ æœƒå¾—åˆ°åƒæ˜¯ä¸‹é¢çš„çµæœï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>author</span>, <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>dbsqlc</span>.<span style=color:#a6e22e>New</span>(<span style=color:#a6e22e>tx</span>).<span style=color:#a6e22e>CreateAuthor</span>(<span style=color:#a6e22e>ctx</span>, <span style=color:#a6e22e>dbsqlc</span>.<span style=color:#a6e22e>CreateAuthor</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;Haruki Murakami&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Bio</span>:  <span style=color:#e6db74>&#34;Author of _Killing Commendatore_. Running and jazz enthusiast.&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>...</span>
</span></span><span style=display:flex><span>})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>, <span style=color:#a6e22e>xerrors</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;error creating author: %w&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;Author name: %s\n&#34;</span>, <span style=color:#a6e22e>author</span>.<span style=color:#a6e22e>Name</span>)
</span></span></code></pre></div><p><strong>sqlc ä¸ç®—æ˜¯ ORM ä½†å®ƒå¯¦ä½œäº†ä¸€æ¨£æœ€æœ‰ç”¨çš„åŠŸèƒ½ï¼Œå°±æ˜¯ mapping query å›åˆ° struct è€Œä¸ç”¨ä»»ä½•çš„ boilerplate</strong>ã€‚</p><p>å¦‚æœä½ ç”±ä¸€å€‹ query åŒ…å«äº† <code>SELECT *</code> æˆ–æ˜¯Â <code>RETURNING *</code>ï¼Œ<strong>å®ƒæœƒçŸ¥é“è¦å›å‚³ä»€éº¼æ±è¥¿ä¸¦ä¸”ç¶å®šå›å» strcutï¼Œæ‰€ä¹Ÿçš„ç‰¹å®š table çš„ queries éƒ½æœ‰ç›¸åŒçš„ output çµæ§‹ã€‚</strong></p><p><strong>sqlc æœ¬èº«ç”¨ <a href=https://github.com/pganalyze/pg_query_go>PGAnalyze</a>ï¼Œé€™å’Œ Postgres çš„ query parser åŸºæœ¬ä¸Šæ˜¯åŒä¸€å€‹</strong>ã€‚åˆ°ç›®å‰ç‚ºæ­¢éƒ½æ²’æœ‰çµ¦æˆ‘å¸¶éä»€éº¼éº»ç…©ï¼Œè€Œä¸”éå¸¸è¤‡é›œçš„æŸ¥è©¢ä¹Ÿèƒ½é †åˆ©åŸ·è¡Œã€‚</p><p><strong>é€™å€‹ query parsing é‚„æœ‰ pre-runtime code verificationï¼Œå¯ä»¥é å…ˆç¢ºèªä½ çš„ code æ˜¯ä¸æ˜¯æœ‰ bugï¼Œå¦‚æœä½ çš„ SQL å¯«éŒ¯ï¼Œç·¨è­¯åˆ° Go å°±ç›´æ¥ä¸æœƒéã€‚æ¯”èµ· SQL-in-Go-strings å¯¦åœ¨æ˜¯å¥½å¤ªå¤šäº†ã€‚å¦‚æœä½ é‚„æ˜¯æƒ³è¦å¯«æ¸¬è©¦ä¹Ÿæ˜¯å¯ä»¥ï¼Œä¸éä½ ä¸éœ€è¦å»è€ƒæ…®æ‰€æœ‰è©³ç›¡çš„ corner caseã€‚</strong></p><h2 id=codegen>Codegen</h2><p>å…¶å¯¦æˆ‘å€‹äººå¾—å“²å­¸å° codegen æœ‰é» â€éæ•â€ï¼Œè®“æˆ‘ä¸å¤ªé¡˜æ„èŠ±æ™‚é–“æ·±å…¥ç ”ç©¶ã€‚</p><p>ä¸éæœ€çµ‚ sqlc ç²å¾—äº†æˆ‘çš„é’çã€‚sqlc å°±åƒå…¶ä»– pkg å®‰è£ä¸€æ¨£ç°¡å–®åªéœ€è¦ä¸€å€‹æŒ‡ä»¤å°±å¯ä»¥äº† (<code>go install github.com/kyleconroy/sqlc/cmd sqlc@latest</code>)ï¼Œ<strong>è€Œä¸”æˆ‘å€‘çš„è€Œä¸”æˆ‘å€‘çš„ project åŒ…å«è¶…é 100 å€‹ queriesï¼Œå¯¦éš›ä¸Šç·¨è­¯å®Œæˆçš„æ™‚é–“ä¸åˆ°ä¸€ç§’é˜ï¼</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ time sqlc generate
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>real    0.07s
</span></span><span style=display:flex><span>user    0.08s
</span></span><span style=display:flex><span>sys     0.01s
</span></span></code></pre></div><p>æˆ‘æƒ³å°±ç®—æˆ‘æˆ‘å€‘æŠŠ queries çš„æ•¸é‡å¢åŠ  x100 è®Šæˆ 10000ï¼Œæˆ‘åœ¨é–‹ç™¼ç”Ÿæ™‚ä¹Ÿä¸æœƒé€ æˆå¤ªå¤§çš„éšœç¤™ã€‚</p><h2 id=pgx-support-appears>pgx support appears</h2><p>åœ¨é€™ä¹‹å‰ï¼Œ<strong>æˆ‘å€‘æœ€å¤§åŸå› æ²’æœ‰é¸æ“‡ sqlc çš„åŸå› æ˜¯å› ç‚ºä¸æ”¯æ´ pgx</strong>ï¼Œä¸éæœ€è¿‘çš„ PR å·²ç¶“è§£æ±ºäº†é€™å€‹å•é¡Œï¼Œè€Œä¸”é‚„æä¾›å¾ˆå¤šçš„ driver ä¾›æˆ‘å€‘ä½¿ç”¨ã€‚</p><p><strong>sqlc çš„ä½œè€…å€‘ç”¨éå¸¸ loosely coupled çš„æ–¹å¼å»å¯«ã€‚åƒæˆ‘å€‘å¾ˆå¤šå°ˆæ¡ˆå·²ç¶“å¤§é‡ä¾è³´ pgxï¼Œä½†æ˜¯æˆ‘ä¾ç„¶èƒ½å¤ åœ¨ä¸€å€‹å°æ™‚å…§æŠŠ sqlc çš„ code é·ç§»åˆ° pgx ä¸Šé¢ï¼Œé€™è®“æˆ‘å€‘ migrate code è®Šå¾—éå¸¸è¼•é¬†ï¼</strong></p><h2 id=caveats-and-workarounds>Caveats and workarounds</h2><p>æ¯”èµ·å‚³çµ± ORM sqlc é‚„æ˜¯æœ‰ä¸€äº›æ¯”è¼ƒä¸æ–¹ä¾¿çš„åœ°æ–¹ï¼Œä½†æ˜¯æœ‰æ–¹æ³•å¯ä»¥å¾ˆå¥½çš„è§£æ±ºã€‚ä¾‹å¦‚ï¼šsqlc ä¸èƒ½ä»»æ„å¡«å¯«åƒæ•¸ï¼Œæ‰€ä»¥ multi-row insert å¯èƒ½ä¸æœƒåƒä½ é æœŸçš„ä¸€æ¨£åŸ·è¡Œï¼Œä½†æ˜¯ä½ å¯ä»¥æ¡å–å‚³è¼¸ batch ç•¶ä½œ array çš„æ–¹å¼å»åŸ·è¡Œå®ƒï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Upsert many marketplaces, inserting or replacing data as necessary.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>INSERT</span> <span style=color:#66d9ef>INTO</span> marketplace (
</span></span><span style=display:flex><span>    name,
</span></span><span style=display:flex><span>    display_name
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>SELECT</span> <span style=color:#66d9ef>unnest</span>(<span style=color:#f92672>@</span><span style=color:#66d9ef>names</span>::text[]) <span style=color:#66d9ef>AS</span> name,
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>unnest</span>(<span style=color:#f92672>@</span>display_names::text[]) <span style=color:#66d9ef>AS</span> display_names
</span></span><span style=display:flex><span><span style=color:#66d9ef>ON</span> CONFLICT (name)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>DO</span> <span style=color:#66d9ef>UPDATE</span> <span style=color:#66d9ef>SET</span> display_name <span style=color:#f92672>=</span> EXCLUDED.display_name
</span></span><span style=display:flex><span>RETURNING <span style=color:#f92672>*</span>;
</span></span></code></pre></div><p>å¦å¤–ä¸€å€‹ä¾‹å­å‰‡æ˜¯ <code>UPDATE</code>ï¼Œæ­£å¸¸ä¾†èªª ORM å°±æ˜¯æŠŠç›®æ¨™æ¬„ä½çš„çš„æ•¸å€¼å¡«ä¸Šå»å°±å¥½ (ä¾‹å¦‚ï¼š<code>UPDATE foo SET a = 1, b = 2, c = 3, â€¦</code>)ã€‚é€™ç¨®æ–¹å¼åœ¨ sqlc æ˜¯è¡Œä¸é€šçš„ï¼Œæ‰€æœ‰çš„ Queries éƒ½å¿…é ˆäº‹å…ˆçµæ§‹åŒ–ï¼Œæ‰€ä»¥ä½ å¯ä»¥åœ¨æ›´æ–°æ™‚å¸¶å…¥ bool çš„æ–¹å¼ç¢ºèªï¼Œä¾‹å¦‚ï¼š</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#75715e>-- Update a team.
</span></span></span><span style=display:flex><span><span style=color:#75715e>-- name: TeamUpdate :one
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>UPDATE</span> team
</span></span><span style=display:flex><span><span style=color:#66d9ef>SET</span>
</span></span><span style=display:flex><span>    customer_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>CASE</span> <span style=color:#66d9ef>WHEN</span> <span style=color:#f92672>@</span>customer_id_do_update::boolean
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>THEN</span> <span style=color:#f92672>@</span>customer_id::VARCHAR(<span style=color:#ae81ff>200</span>) <span style=color:#66d9ef>ELSE</span> customer_id <span style=color:#66d9ef>END</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    has_payment_method <span style=color:#f92672>=</span> <span style=color:#66d9ef>CASE</span> <span style=color:#66d9ef>WHEN</span> <span style=color:#f92672>@</span>has_payment_method_do_update::boolean
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>THEN</span> <span style=color:#f92672>@</span>has_payment_method::bool <span style=color:#66d9ef>ELSE</span> has_payment_method <span style=color:#66d9ef>END</span>,
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    name <span style=color:#f92672>=</span> <span style=color:#66d9ef>CASE</span> <span style=color:#66d9ef>WHEN</span> <span style=color:#f92672>@</span>name_do_update::boolean
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>THEN</span> <span style=color:#f92672>@</span>name::text <span style=color:#66d9ef>ELSE</span> name <span style=color:#66d9ef>END</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>WHERE</span>
</span></span><span style=display:flex><span>    id <span style=color:#f92672>=</span> <span style=color:#f92672>@</span>id
</span></span><span style=display:flex><span>RETURNING <span style=color:#f92672>*</span>;
</span></span></code></pre></div><p>Go ç”Ÿæˆçš„ code å°±æœƒåƒæ˜¯é€™æ¨£</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span>team, err <span style=color:#f92672>=</span> queries.TeamUpdate(ctx, dbsqlc.TeamUpdateParams<span style=color:#960050;background-color:#1e0010>{</span>
</span></span><span style=display:flex><span>    NameDoUpdate: <span style=color:#66d9ef>true</span>,
</span></span><span style=display:flex><span>    Name:         req.Name,
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>)
</span></span></code></pre></div><h1 id=summary-and-future>Summary and future</h1><p>ä»¥ä¸Šæˆ‘å·²ç¶“ä»‹ç´¹äº†å¤§éƒ¨åˆ†çš„ sqlc çš„å¥½è™•ï¼Œæ„Ÿè¦ºå°±åƒæ˜¯ç”¨ Go ä¸€æ¨£æˆ‘å¯ä»¥å¿«é€Ÿåˆæ­£ç¢ºçš„å®Œæˆæˆ‘çš„å·¥ä½œï¼Œä¸ç”¨æ•´å¤©å’Œè¨ˆç®—æ©Ÿæœ¬èº«å°è‘—å¹¹ã€‚</p><p>ä¸éæˆ‘ä¸æœƒèªªå®ƒæ˜¯æ•´å€‹ ecosystems æœ€å¥½çš„è§£æ±ºæ–¹æ¡ˆï¼ŒRustâ€™s SQL drivers ä¹Ÿæœ‰å¯èƒ½åšå‡ºåƒé­”æ³•ä¸€æ¨£çš„æ±è¥¿ï¼Œä¸éè‡³å°‘åœ¨ Go é ˜åŸŸæ²’æœ‰ç–‘å• sqlc æ˜¯æœ€å¥½çš„æ–¹æ¡ˆã€‚</p><p>æœªä¾† Go æœƒå¼•å…¥ genericsï¼Œå¯èƒ½æœƒå¾¹åº•æ”¹è®Šé€™å€‹å°ˆæ¡ˆå…§éƒ¨å»ºæ§‹çš„æ¨¡å¼ï¼Œæˆ–æ˜¯å•Ÿç™¼æ–°çš„ ORMsï¼Œä½†è‡³å°‘é€™ä¸€å…©å¹´çš„ç¶“é©—æˆ‘å€‘å° sqlc éå¸¸æ»¿æ„ï¼</p></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/tags/engineering>Engineering</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/tachunwu rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a></div><div class=footer-info>2023 ğŸ’  Â© Tachunn | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script async src="https://www.googletagmanager.com/gtag/js?id=G-2LYZQ778V0"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2LYZQ778V0")</script><script>feather.replace()</script></div></body></html>